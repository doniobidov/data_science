import subprocess
import glob

# Define a dictionary to store the filtering string for each device
ip_filter = {
    'TCP_Assistant': 'tcp && (ip.src==192.168.1.111 || ip.src==192.168.1.30 || ip.src==192.168.1.42 || ip.src==192.168.1.59 || ip.src==192.168.1.70)',
    'TCP_Camera': 'tcp && (ip.src==192.168.1.128 || ip.src==192.168.1.145 || ip.src==192.168.1.78)',
    'TCP_Miscellaneous': 'tcp && (ip.src==192.168.1.216 || ip.src==192.168.1.46 || ip.src==192.168.1.84 || ip.src==192.168.1.91)',
    'TCP_Mobile': 'tcp && (ip.src==192.168.1.45)',
    'TCP_Outlet': 'tcp && (ip.src==192.168.1.222 || ip.src==192.168.1.67)'
}

# Open a csv file to store the labels and features
with open('label_feature_IOT.csv', 'a') as labelFeature:
    # Write header
    labelFeature.writelines('Label,IPLength,IPHeaderLength,TTL,'
                            'Protocol,SourcePort,DesrPort,SequenceNumber,AckNumber,'
                            'WindowSize,TCPHeaderLength,TCPLength,TCPStream,'
                            'TCPUrgentPointer,TCPFlags,IPID,IPchecksum,TCPflags,TCPChecksum\n')

    # Filter out all the packets from the 5 different devices and save the result into new pcap files
    for original in glob.glob('tcp*.pcap'):
        for k in ip_filter.keys():
            filtered_file = "filtered_" + k + ".pcap"
            tshark_command = ["tshark", "-r", original, "-w", filtered_file, "-Y", ip_filter[k]]
            subprocess.run(tshark_command)

    # Create the labels and extract the features for them with the newly generated pcap files
    for filtered_file in glob.glob('filtered_*.pcap'):
        filename = filtered_file.replace('filtered_', '')
        # Extract label from the file name
        label = filename.replace('.pcap', '')

        # Use tshark command to extract features
        tshark_command = ["tshark", "-r", filtered_file, "-T", "fields",
                          "-e", "ip.len", "-e", "ip.hdr_len", "-e", "ip.ttl",
                          "-e", "ip.proto", "-e", "tcp.srcport", "-e", "tcp.dstport",
                          "-e", "tcp.seq", "-e", "tcp.ack", "-e", "tcp.window_size_value",
                          "-e", "tcp.hdr_len", "-e", "tcp.len", "-e", "ip.flags",
                          "-e", "ip.id", "-e", "ip.checksum", "-e", "tcp.flags",
                          "-e", "tcp.checksum"]

        # Execute the command and capture output
        process = subprocess.Popen(tshark_command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        output, error = process.communicate()

        if process.returncode != 0:
            print("Error executing tshark command:", error)
        else:
            # Process the output
            allFeatures = output.decode()
            allFeatures = allFeatures.replace('\t', ',')
            allFeaturesList = allFeatures.splitlines()
            for features in allFeaturesList:
                labelFeature.writelines(label + "," + features + "\n")

print('Finished')
